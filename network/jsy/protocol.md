# :question: IPv4, ICMP 프로토콜

#### reference
https://engineeringcode.tistory.com/49<br>
https://ming9mon.tistory.com/13<br>
https://rimkongs.tistory.com/278<br>
https://uiyoji-journal.tistory.com/16
<hr>

## Question
1. [IPv4가 하는일과 IPv4 프로토콜 구조를 설명해주세요.](#1-ipv4)
- 3계층 프로토콜로, 네트워크 상에서 데이터를 교환하기 위해 통신하기 위한 특정 주소를 지정하는 일을 합니다.
<br><br/>

2. [ICMP가 하는일과 ICMP 프로토콜 구조를 설명해주세요.](#2-icmp-internet-control-message-protocol)
- 3계층 프로토콜로, 데이터 전송 중에 오류가 발생할 경우 오류 메시지를 전송하여 오류 상황을 알려주는 역할을 합니다.
<br><br/>

3. [다른 네트워크까지 내 패킷의 이동 과정을 설명해주세요.](#3-packet-이동-과정)
- 1. 스위치를 통해 다른 네트워크에 있는 목적지의 IP 주소를 담은 패킷을 보내며, 통신을 시도합니다.
- 2. 해당 스위치는 자신의 네트워크에 목적지 IP 주소가 없는 것을 확인한 후, 라우터에게 해당 IP 주소를 가지고 있는 네트워크를 찾아달라고 요청합니다. (switch -> router)
- 3. 라우터가 라우팅 테이블을 참조하여 목적지 IP 주소를 가진 네트워크를 찾습니다. (router -> routing table -> router)
- 4. 네트워크를 찾으면, 해당 네트워크에 있는 라우터에게 목적지 IP 주소가 전달되고, 그 주소를 스위치에게 전달합니다. (router -> switch)
- 5. 스위치는 목적지에게 패킷을 전달합니다.
- 6. 이후, 패킷을 잘 받았다는 응답을 역순의 과정으로 보냅니다.
<hr/>

## :nerd_face:	What I study
### 1. IPv4
- 주소 지정에 가장 많이 사용되는 3계층 프로토콜
- 네트워크 상에서 데이터를 교환하기 위한 프로토콜
- 다른 네트워크의 특정 대상을 찾는 프로토콜
- 데이터가 ***정확하게 전달되는 것을 보장하지 않는다.*** (비신뢰성)
- 중복된 패킷을 전달하거나 패킷의 순서를 잘못 전달할 가능성도 있다.
- 4계층 프로토콜인 TCP에서 데이터의 정확하고 순차적인 전달을 보장한다.
#### 1) IPv4 구조
- 32비트의 IP 주소가 사용된다.
- 전체 32비트를 8비트씩 4개 단위로 끊은 후, 10진수로 변환하여 표기한다.
![ipv4](https://blog.kakaocdn.net/dn/bSGzOp/btqKSWLT9iH/dypOd7iFYkMQEZnhF7PeY0/img.png)
- VER: 인터넷 프로토콜의 버전 <br> ex) IPv4, IPv5, IPv6 ..
- HLEN: 헤더의 길이 <br> cf) IPv6에는 이 필드가 없다.
- Service type: IP 데이터그램의 서비스 형태 <br>이 필드를 통해, 이 패킷이 얼마나 중요하고 긴급한지를 알 수 있다. -> QoS 구현 가능
  - DSCP(6bit): 서비스 유형을 의미하는 필드
  - ECN(2bit): 경로의 혼잡 정보를 담는 필드, 지금은 쓰지 않는 필드
- Total length: 헤더의 크기까지 포함한 IP 데이터그램의 크기
- Identification: IP 데이터그램을 구분하는 필드<br>cf) IPv6에는 이 필드가 없다. (IPv6는 라우터가 패킷을 단편화하지 않는다.)
- Flags: IP 데이터그램이 단편화되었는지 나타내는 필드<br>cf) IPv6에는 이 필드가 없다.
- Fragmentation offset: 단편화된 데이터그램의 순서를 나타내는 필드<br>cf) IPv6에는 이 필드가 없다.
- TTL(Time To Live): 패킷이 라우터를 최대 몇 번 거쳐서까지 살아 남는지를 나타내는 필드
- Protocol: IP 데이터그램의 데이터(페이로드)에 담겨져 있는 상위 계층의 프로토콜을 알려주는 필드
  - ex) ICMP: 1번, TCP: 6번, UDP: 17번 ...
- Header checksum: Header 필드의 오류를 검출할 수 있는 정보가 담긴 필드<br>cf) IPv6에는 이 필드가 없다.
  - 과거에는 노드간 통신 중에 패킷이 깨지는 경우가 많았다.<br>-> 라우터에서 한번 더 오류검출을 하여 패킷 손실 여부를 파악하기 위해 만들어진 필드이다.
- Source IP address: 패킷을 보낸 노드의 IP 주소
- Destination IP address: 패킷이 도착해야하는 목적지의 IP 주소

#### 2) MTU (Maximum Transmission Unit)
- 네트워크 인터페이스에서 한 번에 전송할 수 있는 데이터 크기 (최대 데이터그램 크기)
- 라우터가 데이터를 전송하기 전에 통신 경로 전체의 MTU를 살펴본 후, MTU보다 작은 크기의 패킷으로 패킷을 조각화하여 데이터 유실을 방지하기도 한다.
<br><br/>

### 2. ICMP (Internet Control Message Protocol)
- 3계층 프로토콜
- 데이터 전송 중에 문제가 생길 경우, 오류 상황을 통보하기 위해 사용된다.
- OS에서 **오류 메시지를 전송받는데** 주로 사용된다.
- 프로토콜 구조의 타입과 코드를 통해 오류 메시지를 전송 받는다.
#### 1) ICMP 구조
![icmp](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Ft1.daumcdn.net%2Fcfile%2Ftistory%2F99F0C6495B839BED2A)
- Type: 패킷 내에 어떠한 종류의 ICMP 메시지가 있는지 정의, 상대방이랑 통신이 안될 때, 무슨 상황인지 type을 통해 알아낼 수 있음
- Code: type에 대한 상세 설명
- Checksum: 전달된 패킷이 손실없이 도착했는지 체크
- Message: 각 타입별로 다르게 구성됨

#### 2) 알아야하는 Type 넘버
- 0: Echo Reply, ICMP 에 대한 응답,<br>수신 측 장비가 존재한다고 알리기 위해 사용
- 3: Destination network unreachable, 패킷이 목적지에 도달할 수 없음, 데이터가 도착하지 않음<br>***가는 경로에 문제가 있음***
  - 3-0: 하드웨어 고장 등의 이유
  - 3-1: 호스트에 도달할 수 없음, 하드웨어 고장 가능성 있음
  - 3-2: 프로토콜에 도달할 수 없음, 목적지 호스트가 생성
  - 3-3: 포트에 도달할 수 없음, 목적지 호스트가 생성
  - 3-4: 단편화가 필요하지만 데이터그램에 DF 필드가 설정되어 있다.
- 5: Redirect, 경로 상태가 최적이 아님
  - 5-0: 네트워크 지정 경로를 위한 재지정
  - 5-1: 호스트 지정 경로를 위한 재지정
  - 5-2: 특정한 서비스 유형에 기초한 네트워크 지정 경로를 위한 재지정
  - 5-3: 특정한 서비스 유형에 기초한 호스트 지정 경로를 위한 재지정
- 8: Echo Request, ICMP에 대한 요청, <br>수신 측 장비가 존재하는지 확인할 때 사용
- 11: TTL expired in transmit, 요청 시간이 만료되었음<br>***상대방에게 문제가 있음***
  - 11-0: TTL이 0이 되었음
  - 11-1: 재조립 시간 초과
<br><br/>

### 3. Packet 이동 과정
#### 1) Packet
- 데이터의 묶음 단위
- 한 번에 전송할 데이터의 크기
#### 2) Switch
- MAC 주소와 포트 번호가 기록된 MAC 주소 테이블을 가지고 있다.
- 목적지 MAC 주소를 가진 장비가 연결된 포트로만 프레임을 전송한다.
- 한 포트에서 전송된 프레임이 MAC 주소 테이블에 있는 특정 포트로만 전송되기 때문에, 다른 포트가 전송하는 프레임과 충돌이 일어나지 않는다.
- 프레임의 목적지 MAC 주소가 브로드캐스트인 경우, 수신한 프레임을 모든 포트로 전송한다.
#### 3) Router
- 패킷의 위치를 추출하여  그 위치에 대한 최적의 경로를 지정하며, 이 경로를 따라 패킷을 다음 장치로 전달하는 장치
- 네트워크 계층에서 ***IP 주소를 이용***하여 네트워크 간의 패킷을 전달하는 것
#### 4) Routing
- 라우터가 자신과 연결된 다른 라우터를 찾아가면서 최종 목적지까지 연결되는 최적의 경로를 찾아나가는 과정
#### 5) Routing Table
- 라우팅에 활용되는 테이블
- 컴퓨터 네트워크에서 목적지 주소를 목적지에 도달하기 위한 네트워크 노선으로 변환시킬 목적으로 사용된다.
- 목적지 호스트가 속한 네트워크 정보, 그 네트워크로 도달하기 위해 경유해야 하는 라우터들의 정보가 들어있다.
#### 6) Routing 종류
- 정적 라우팅
  - 네트워크 관리자가 직접 수작업으로 라우팅 테이블을 설정하는 방식
  - 소규모 네트워크에 적합
- 동적 라우팅
  - 주로 사용하는 방식
  - 라우팅 프로토콜을 사용하여 자동적으로 경로 정보를 수집한 후, 라우팅 테이블을 설정하는 방식
  - 대규모 네트워크에 적합
#### 7) 다른 네트워크와 통신 과정
![comm](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FcVPfJs%2FbtqK4Jm17Qp%2FN5Mg7voU4CCuahBkiXN83k%2Fimg.png)
- cf) ethernet 프로토콜은 네트워크 대역이 바뀔 때마다, 새로 갱신된다.<br>다른 네트워크를 찾아갈 경우에는 반드시 Gateway(ex. router)를 통해서 통신해야 한다.
1. 송신자는 자신의 IP 주소와 MAC 주소 정보, 목적지 IP 주소를 담은 패킷을 switch에게 보내며, 통신을 시도한다.
2. 이 요청을 받은 switch는 자신의 MAC 주소 테이블을 확인한 후, 자신이 담당하는 네트워크에 목적지가 없다는 것을 확인한다.
3. 외부로 나가기 위해, switch는 자신과 연결되어 있는 gateway 장비(**라우터**)에게 해당 IP 주소를 가지고 있는 네트워크를 찾아달라고 요청한다.
4. switch로부터 요청을 받은 router는 자신의 라우팅 테이블을 확인하여 해당 IP 주소를 가진 router를 찾는다.
5. router 끼리는 서로의 정보를 수시로 공유하게 된다. 이 과정을 거쳐서 송신지 네트워크의 router가 목적지 네트워크의 router를 찾아가게 된다. ***->routing(길찾기)***
6. routing 과정이 진행되면서 목적지 네트워크의 router에게 송신자가 요청한 패킷이 도착한다.
7. 목적지 IP 주소를 받은 router는 switch에게 목적지를 찾으라고 요청한다.
8. switch는 목적지를 찾고, 패킷을 전달한다.
9.  이후, 패킷을 잘 받았다는 응답 패킷을 역순의 과정으로 송신자에게 보낸다.